<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Korean Killer - Ultimate</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

    <script src="edge-impulse-standalone.js"></script>

    <style>
        /* [ê¸°ì¡´ KK ìŠ¤íƒ€ì¼ + React UI ìŠ¤íƒ€ì¼ í†µí•©] */
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #111827; color: #eee; }
        
        /* ì‚¬ì´ë“œë°” */
        #sidebar { width: 260px; background-color: #1f2937; padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.5); flex-shrink: 0; border-right: 1px solid #374151; }
        .title-container { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #4b5563; padding-bottom: 20px; }
        #kk-logo { font-size: 6rem; font-weight: 900; color: #ef4444; margin: 0; line-height: 1; letter-spacing: -5px; text-shadow: 0 0 20px rgba(239, 68, 68, 0.6); font-family: 'Arial Black', sans-serif; }
        input, button { padding: 10px; border-radius: 8px; border: 1px solid #4b5563; width: 100%; box-sizing: border-box; background-color: #374151; color: #eee; outline: none; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; background: #ef4444; color: white; border: none; }
        button:hover { opacity: 0.9; transform: scale(1.02); }
        
        /* ë©”ì¸ ì˜ì—­ */
        #main-content { flex-grow: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; gap: 20px; flex-direction: column; 
            background-image: radial-gradient(circle at 50% 50%, rgba(220, 38, 38, 0.1) 0%, transparent 60%), linear-gradient(0deg, #111827 0%, transparent 100%);
        }

        /* [NEW] ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê·¸ë£¹ (ì´ë¯¸ì§€ ë°”ë¡œ ìœ„) */
        #control-bar {
            display: flex; gap: 10px; z-index: 50; margin-bottom: 10px;
        }
        .ctrl-btn {
            background: #1f2937; border: 1px solid #4b5563; color: #9ca3af; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 5px;
        }
        .ctrl-btn:hover { background: #374151; color: white; }
        .ctrl-btn.active { background: #1d4ed8; border-color: #3b82f6; color: white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }

        /* ì´ë¯¸ì§€ ë° ì¹´ë©”ë¼ ì˜ì—­ */
        #visual-area { position: relative; width: 600px; height: 500px; display: flex; justify-content: center; align-items: center; }
        .side-img { height: 100%; width: auto; object-fit: contain; border: 2px solid #374151; box-shadow: 0 0 30px rgba(0,0,0,0.5); opacity: 0.9; transition: 0.3s; border-radius: 10px; }
        .side-img.alert-mode { border-color: #ef4444; box-shadow: 0 0 50px rgba(239, 68, 68, 0.8); transform: scale(1.02); }
        
        /* ì¤Œ ì¹´ë©”ë¼ (ìˆ¨ê¹€ ìƒíƒœì˜€ë‹¤ê°€ ì‹œì‘í•˜ë©´ ë‚˜ì˜´) */
        #camera-wrapper { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; height: 400px; border-radius: 50%; overflow: hidden; 
            border: 4px solid #ef4444; background: black; display: none;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
        }
        canvas { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* [NEW] ì„¤ì • íŒ¨ë„ (React ìŠ¤íƒ€ì¼ ì´ì‹) */
        #settings-panel {
            position: absolute; top: 60px; right: -320px; width: 300px; 
            background: rgba(31, 41, 55, 0.95); border: 1px solid #4b5563; 
            border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);
            transition: 0.3s; z-index: 60; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 15px; opacity: 0; pointer-events: none;
        }
        #settings-panel.show { right: 20px; opacity: 1; pointer-events: all; }
        .setting-item { display: flex; flex-direction: column; gap: 5px; }
        .setting-header { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: bold; color: #9ca3af; }
        .setting-val { color: #60a5fa; font-family: monospace; }
        input[type=range] { width: 100%; height: 4px; background: #4b5563; border-radius: 2px; accent-color: #60a5fa; }

        /* [NEW] ë¡œê·¸ íŒ¨ë„ (React ìŠ¤íƒ€ì¼ ì´ì‹) */
        #log-panel {
            position: absolute; top: 60px; left: -320px; width: 300px; height: 400px;
            background: rgba(31, 41, 55, 0.95); border: 1px solid #4b5563; 
            border-radius: 12px; padding: 15px; backdrop-filter: blur(10px);
            transition: 0.3s; z-index: 60; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; opacity: 0; pointer-events: none;
        }
        #log-panel.show { left: 20px; opacity: 1; pointer-events: all; }
        #log-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .log-item { 
            background: rgba(55, 65, 81, 0.5); padding: 8px; border-radius: 6px; font-size: 0.75rem; 
            display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #4b5563;
        }
        .log-item.violation { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .log-time { color: #9ca3af; font-family: monospace; }
        .log-badge { padding: 2px 6px; border-radius: 4px; font-weight: bold; color: white; }

        /* Alert Overlay */
        #alert-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(220, 38, 38, 0.9); color: white; padding: 20px 40px; border-radius: 50px; font-size: 2rem; font-weight: bold; display: none; z-index: 200; box-shadow: 0 0 50px red; animation: pulse 0.3s infinite alternate; white-space: nowrap; }
        @keyframes pulse { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.1); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }

        #input_video { display: none; }
        #loading-msg { display: none; color: #ef4444; margin-top: 10px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="title-container">
            <h2 style="color:#9ca3af; margin:0; letter-spacing:3px;">KOREAN KILLER</h2>
            <div id="kk-logo">KK</div>
        </div>
        <input type="text" id="input-name" placeholder="Name">
        <input type="text" id="input-id" placeholder="Student ID">
        <button id="btn-start" onclick="startSystem()">â–¶ START SYSTEM</button>
        <div id="loading-msg">Initializing AI...</div>
        <button id="btn-stop" onclick="location.reload()" style="display:none; background:#4b5563;">â¹ RESET</button>
        
        <div style="margin-top:auto; border-top:1px solid #4b5563; padding-top:10px;">
            <p style="color:#ef4444; font-size:0.8rem; margin-bottom:5px;">Admin Controls</p>
            <input type="password" id="admin-pw" placeholder="Password" style="margin-bottom:5px;">
            <button onclick="authAdmin()" style="background:#3b82f6;">Unlock Admin</button>
        </div>
    </div>

    <div id="main-content">
        
        <div id="control-bar">
            <button class="ctrl-btn" id="btn-settings" onclick="togglePanel('settings')">âš™ï¸ Settings</button>
            <button class="ctrl-btn" id="btn-logs" onclick="togglePanel('logs')">ğŸ“Š Live Log</button>
        </div>

        <div id="visual-area">
            <img src="1.jpg" id="monitor-image" class="side-img" alt="Monitor">
            
            <div id="camera-wrapper">
                <canvas id="output_canvas"></canvas>
                <div id="alert-overlay">ğŸš¨ DETECTED!</div>
            </div>
            
            <div id="settings-panel">
                <h3 style="margin:0; color:white; border-bottom:1px solid #4b5563; padding-bottom:10px;">Detection Settings</h3>
                
                <div class="setting-item">
                    <div class="setting-header"><span>AI Confidence</span><span id="val-conf" class="setting-val">50%</span></div>
                    <input type="range" min="1" max="99" value="50" oninput="updateSetting('confidence', this.value)">
                </div>
                
                <div class="setting-item">
                    <div class="setting-header"><span>Mouth Open (Gap)</span><span id="val-mouth" class="setting-val">1.0%</span></div>
                    <input type="range" min="1" max="50" value="10" oninput="updateSetting('mouthOpen', this.value)">
                </div>

                <div class="setting-item">
                    <div class="setting-header"><span>Lip Movement</span><span id="val-lip" class="setting-val">Lv 20</span></div>
                    <input type="range" min="1" max="100" value="20" oninput="updateSetting('lipMovement', this.value)">
                </div>

                <div class="setting-item">
                    <div class="setting-header"><span>Strictness</span><span id="val-strict" class="setting-val">3 frames</span></div>
                    <input type="range" min="1" max="10" value="3" oninput="updateSetting('strictness', this.value)">
                </div>
            </div>

            <div id="log-panel">
                <h3 style="margin:0; color:white; border-bottom:1px solid #4b5563; padding-bottom:10px;">Live Monitor</h3>
                <div id="log-list">
                    <div style="text-align:center; color:#6b7280; margin-top:20px;">Waiting for data...</div>
                </div>
            </div>
        </div>
    </div>

    <video id="input_video" playsinline></video>

    <script>
        var Module = typeof Module !== 'undefined' ? Module : {};
        let classifierInitialized = false;
        Module.onRuntimeInitialized = function() { classifierInitialized = true; };

        class EdgeImpulseClassifier {
            constructor() { this._module = Module; }
            init() {
                if (classifierInitialized === true) return Promise.resolve();
                return new Promise((resolve, reject) => {
                    if (!this._module || !this._module.onRuntimeInitialized) { if (window.Module) this._module = window.Module; }
                    this._module.onRuntimeInitialized = () => {
                        classifierInitialized = true;
                        this._module.init();
                        resolve();
                    };
                });
            }
            classify(rawData, debug = false) {
                if (!classifierInitialized) throw new Error('Module is not initialized');
                if (!this._module._malloc && window.Module) { this._module = window.Module; }
                const obj = this._arrayToHeap(rawData);
                let ret = this._module.run_classifier(obj.buffer.byteOffset, rawData.length, debug);
                this._module._free(obj.ptr);
                if (ret.result !== 0) throw new Error('Classification failed (err code: ' + ret.result + ')');
                let jsResult = { results: [] };
                for (let cx = 0; cx < ret.size(); cx++) {
                    let c = ret.get(cx);
                    jsResult.results.push({ label: c.label, value: c.value });
                    c.delete();
                }
                ret.delete();
                return jsResult;
            }
            _arrayToHeap(data) {
                let typedArray = new Float32Array(data);
                let numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
                let ptr = this._module._malloc(numBytes);
                let heapBytes = new Uint8Array(this._module.HEAPU8.buffer, ptr, numBytes);
                heapBytes.set(new Uint8Array(typedArray.buffer));
                return { ptr: ptr, buffer: heapBytes };
            }
        }
    </script>

    <script>
        // 1. Firebase Setup
        const firebaseConfig = {
            apiKey: "AIzaSyDaLlrTKsMCpCzVgBW9icTmEPcuO_zoWVY",
            authDomain: "acdt-project.firebaseapp.com",
            projectId: "acdt-project",
            storageBucket: "acdt-project.firebasestorage.app",
            messagingSenderId: "243281762920",
            appId: "1:243281762920:web:6641d9eadfe1e93442f9dd",
            measurementId: "G-J9TVZXN3LE"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. Global State & Settings (React useRef/useState ëŒ€ì²´)
        let isRunning = false;
        let userName = "", userId = "";
        let classifier = null; 
        
        // [React ë¡œì§ ì´ì‹] ì„¤ì •ê°’ ê°ì²´
        const settings = {
            confidence: 0.50,   // ê¸°ë³¸ 50%
            mouthOpen: 0.01,    // ê¸°ë³¸ 1.0% (ì¢Œí‘œì°¨ì´)
            lipMovement: 0.002, // ê¸°ë³¸ í‘œì¤€í¸ì°¨
            strictness: 3       // ì—°ì† í”„ë ˆì„ ìˆ˜
        };

        // [React ë¡œì§ ì´ì‹] ë¶„ì„ìš© íˆìŠ¤í† ë¦¬
        const lipHistory = []; // ì… ì›€ì§ì„ ê³„ì‚°ìš©
        const violationQueue = []; // ì—°ì† ì ë°œ ê³„ì‚°ìš©
        let alertTimeout = null;

        // 3. UI Control Functions
        function togglePanel(panelName) {
            const settingsPanel = document.getElementById('settings-panel');
            const logPanel = document.getElementById('log-panel');
            const btnSettings = document.getElementById('btn-settings');
            const btnLogs = document.getElementById('btn-logs');

            if (panelName === 'settings') {
                settingsPanel.classList.toggle('show');
                btnSettings.classList.toggle('active');
                // ë¡œê·¸ íŒ¨ë„ì´ ì¼œì ¸ìˆìœ¼ë©´ ëˆë‹¤ (ê²¹ì¹¨ ë°©ì§€)
                if(logPanel.classList.contains('show')) {
                    logPanel.classList.remove('show');
                    btnLogs.classList.remove('active');
                }
            } else if (panelName === 'logs') {
                logPanel.classList.toggle('show');
                btnLogs.classList.toggle('active');
                if(settingsPanel.classList.contains('show')) {
                    settingsPanel.classList.remove('show');
                    btnSettings.classList.remove('active');
                }
            }
        }

        function updateSetting(key, value) {
            // UI ì—…ë°ì´íŠ¸ ë° ë‚´ë¶€ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            if (key === 'confidence') {
                settings.confidence = value / 100;
                document.getElementById('val-conf').innerText = value + '%';
            } else if (key === 'mouthOpen') {
                settings.mouthOpen = value / 1000;
                document.getElementById('val-mouth').innerText = (value/10).toFixed(1) + '%';
            } else if (key === 'lipMovement') {
                settings.lipMovement = value / 10000;
                document.getElementById('val-lip').innerText = 'Lv ' + value;
            } else if (key === 'strictness') {
                settings.strictness = parseInt(value);
                document.getElementById('val-strict').innerText = value + ' frames';
            }
        }

        function addLog(label, score, mouthState, isViolation) {
            const list = document.getElementById('log-list');
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            
            const div = document.createElement('div');
            div.className = `log-item ${isViolation ? 'violation' : ''}`;
            div.innerHTML = `
                <div>
                    <span class="log-time">[${timeStr}]</span>
                    <span style="color:#eee; font-weight:bold; margin-left:5px;">${label.toUpperCase()}</span>
                    <span style="color:#6b7280; font-size:0.7rem;">(${mouthState})</span>
                </div>
                <div class="log-badge" style="background:${isViolation ? '#ef4444' : '#10b981'}">
                    ${Math.round(score*100)}%
                </div>
            `;
            
            list.insertBefore(div, list.firstChild);
            // ë¡œê·¸ 20ê°œ ìœ ì§€
            if (list.children.length > 20) list.removeChild(list.lastChild);
        }

        // [React ë¡œì§ ì´ì‹] í‘œì¤€í¸ì°¨ ê³„ì‚° í•¨ìˆ˜
        function calculateStandardDeviation(arr) {
            if (arr.length === 0) return 0;
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / arr.length;
            return Math.sqrt(variance);
        }

        // 4. System Start Logic
        async function startSystem() {
            userName = document.getElementById('input-name').value;
            userId = document.getElementById('input-id').value;
            if (!userName || !userId) { alert("Please enter Name and Student ID!"); return; }

            const btn = document.getElementById('btn-start');
            const msg = document.getElementById('loading-msg');
            btn.disabled = true;
            btn.style.opacity = "0.5";
            msg.style.display = 'block';

            try {
                // 1. Edge Impulse Init
                msg.innerText = "Step 1: Loading AI Brain...";
                classifier = new EdgeImpulseClassifier();
                await classifier.init();
                
                // 2. Camera & FaceMesh Init
                msg.innerText = "Step 2: Connecting Eyes...";
                await startFaceMesh();
                
                // 3. Audio Init
                msg.innerText = "Step 3: Opening Ears...";
                await startAudioProcessing();

                // UI ì „í™˜
                msg.style.display = 'none';
                btn.style.display = 'none';
                document.getElementById('btn-stop').style.display = 'block';
                document.getElementById('camera-wrapper').style.display = 'block'; // ì¤Œ ì¹´ë©”ë¼ í‘œì‹œ
                
                // ë¡œê·¸ íŒ¨ë„ ìë™ ì˜¤í”ˆ (ì„ íƒì‚¬í•­)
                togglePanel('logs'); 
                
                isRunning = true;

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                location.reload();
            }
        }

        // [React ë¡œì§ ì´ì‹] ì˜¤ë””ì˜¤ ì²˜ë¦¬
        async function startAudioProcessing() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            
            // AI íƒ€ê²Ÿ ì£¼íŒŒìˆ˜ (16kHz)
            const targetRate = 16000; 
            const processor = audioContext.createScriptProcessor(4096, 1, 1);
            let audioBuffer = new Float32Array(targetRate * 1); // 1ì´ˆ ë²„í¼
            let bufferIdx = 0;

            source.connect(processor);
            processor.connect(audioContext.destination);

            processor.onaudioprocess = function(e) {
                if (!isRunning) return;
                const inputData = e.inputBuffer.getChannelData(0);
                // ë‹¤ìš´ìƒ˜í”Œë§
                const downsampled = downsampleBuffer(inputData, audioContext.sampleRate, targetRate);

                for (let i = 0; i < downsampled.length; i++) {
                    if (bufferIdx < audioBuffer.length) {
                        audioBuffer[bufferIdx] = downsampled[i];
                        bufferIdx++;
                    } else {
                        // ë²„í¼ê°€ ì°¨ë©´ ë¶„ë¥˜ ì‹¤í–‰
                        runClassification(audioBuffer);
                        bufferIdx = 0; // ë²„í¼ ë¦¬ì…‹ (ê°„ë‹¨ êµ¬í˜„)
                    }
                }
            };
        }

        function downsampleBuffer(buffer, sampleRate, outSampleRate) {
            if (outSampleRate == sampleRate) return buffer;
            var sampleRateRatio = sampleRate / outSampleRate;
            var newLength = Math.round(buffer.length / sampleRateRatio);
            var result = new Float32Array(newLength);
            var offsetResult = 0;
            var offsetBuffer = 0;
            while (offsetResult < result.length) {
                var nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                var accum = 0, count = 0;
                for (var i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        // [React ë¡œì§ ì´ì‹] ìµœì¢… íŒë‹¨ ë¡œì§
        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ì˜¤ë””ì˜¤ ë¶„ì„ ê²°ê³¼ ì €ì¥
        let currentAudioResult = { label: 'noise', score: 0 };

        async function runClassification(data) {
            try {
                if(!classifier) return;
                let results = classifier.classify(data);
                
                // ê°€ì¥ ë†’ì€ ì ìˆ˜ ì°¾ê¸°
                let topResult = results.results.reduce((prev, curr) => prev.value > curr.value ? prev : curr);
                currentAudioResult = { label: topResult.label, score: topResult.value };

            } catch (ex) { console.log("AI Error:", ex); }
        }

        // ë¹„ì „ ì²˜ë¦¬ ë£¨í”„ (FaceMesh)
        async function startFaceMesh() {
            const videoElement = document.getElementById('input_video');
            const canvasElement = document.getElementById('output_canvas');
            const ctx = canvasElement.getContext('2d');
            const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
            
            faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5 });
            
            faceMesh.onResults((results) => {
                if (!isRunning) return;

                // ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸°
                canvasElement.width = 400; canvasElement.height = 400;
                ctx.save();
                ctx.scale(-1, 1);
                ctx.translate(-400, 0);
                ctx.drawImage(results.image, 0, 0, 400, 400);

                // ì–¼êµ´ ê°ì§€ë¨
                let visualState = 'Closed';
                let isViolation = false;

                if (results.multiFaceLandmarks.length > 0) {
                    const lm = results.multiFaceLandmarks[0];
                    // ì…ìˆ  ì¢Œí‘œ (ìƒ:13, í•˜:14)
                    const upper = lm[13]; 
                    const lower = lm[14];
                    
                    // ì… ë²Œë¦¼ ì •ë„ (Yì¢Œí‘œ ì°¨ì´)
                    const gap = lower.y - upper.y;
                    
                    // [React ë¡œì§] ì… ì›€ì§ì„ í‘œì¤€í¸ì°¨ ê³„ì‚°
                    lipHistory.push(gap);
                    if (lipHistory.length > 5) lipHistory.shift();
                    const movement = calculateStandardDeviation(lipHistory);

                    // ì‹œê°í™” (ì´ˆë¡ì )
                    ctx.fillStyle = "#00FF00";
                    const uX = upper.x * 400; const uY = upper.y * 400;
                    const lX = lower.x * 400; const lY = lower.y * 400;
                    ctx.beginPath(); ctx.arc(uX, uY, 3, 0, 2*Math.PI); ctx.fill();
                    ctx.beginPath(); ctx.arc(lX, lY, 3, 0, 2*Math.PI); ctx.fill();

                    // [í•µì‹¬ íŒì • ë¡œì§]
                    if (gap > settings.mouthOpen) {
                        if (movement > settings.lipMovement) {
                            visualState = 'Speaking';
                        } else {
                            visualState = 'Open';
                        }
                    }

                    // ì˜¤ë””ì˜¤ + ë¹„ë””ì˜¤ ê²°í•© íŒì •
                    const isKorean = currentAudioResult.label === 'korean' && currentAudioResult.score > settings.confidence;
                    const isMouthActive = visualState === 'Speaking';

                    if (isKorean && isMouthActive) {
                        violationQueue.push(1);
                    } else {
                        violationQueue.push(0);
                    }
                    if (violationQueue.length > 10) violationQueue.shift();

                    // ì—°ì† í”„ë ˆì„ ì²´í¬ (Strictness)
                    const violationCount = violationQueue.filter(v => v === 1).length;
                    
                    if (violationCount >= settings.strictness) {
                        isViolation = true;
                        triggerDetection();
                    }
                }
                ctx.restore();

                // ë¡œê·¸ ì—…ë°ì´íŠ¸ (ë„ˆë¬´ ìì£¼ ì•ˆ í•˜ë„ë¡, ë³€ê²½ ìˆì„ë•Œë‚˜ 1ì´ˆë§ˆë‹¤ í•˜ë©´ ì¢‹ì§€ë§Œ ì—¬ê¸°ì„  ë§¤ í”„ë ˆì„ ì—…ë°ì´íŠ¸í•˜ë˜ DOM ë¶€í•˜ ê³ ë ¤ í•„ìš”)
                // ê°„ë‹¨í•˜ê²Œ ìœ„ë°˜ ì‹œ ë˜ëŠ” ì¼ì • í™•ë¥ ë¡œ ë¡œê·¸ ì°ê¸°
                if (Math.random() < 0.05 || isViolation) {
                    addLog(currentAudioResult.label, currentAudioResult.score, visualState, isViolation);
                }

            });

            const camera = new Camera(videoElement, {
                onFrame: async () => { await faceMesh.send({image: videoElement}); },
                width: 640, height: 480
            });
            await camera.start();
        }

        function triggerDetection() {
            // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ì¿¨ë‹¤ìš´ (2ì´ˆ)
            const now = Date.now();
            if (alertTimeout) return; 

            // 1. Overlay
            const overlay = document.getElementById('alert-overlay');
            overlay.style.display = 'block';
            
            // 2. Image Switch (1.jpg -> 2.jpg)
            const img = document.getElementById('monitor-image');
            img.src = "2.jpg"; 
            img.classList.add('alert-mode');

            // 3. DB Upload
            db.collection("detections").add({ 
                name: userName, studentId: userId, 
                reason: `Korean(${Math.round(currentAudioResult.score*100)}%)`, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            });

            // 4. Reset Timer
            alertTimeout = setTimeout(() => {
                overlay.style.display = 'none';
                img.src = "1.jpg";
                img.classList.remove('alert-mode');
                alertTimeout = null;
                // í ì´ˆê¸°í™” (ì—°ì† ì ë°œ ë°©ì§€)
                violationQueue.length = 0;
            }, 3000);
        }

        function authAdmin() {
            const pw = document.getElementById('admin-pw').value;
            if(pw === "kyj") {
                alert("Admin Unlocked: You can now access full logs.");
            } else {
                alert("Wrong Password");
            }
        }
    </script>
</body>
</html>
