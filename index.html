<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Korean Killer</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

    <script src="edge-impulse-standalone.js"></script>

    <style>
        /* [Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Ïú†ÏßÄ] */
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #1a1a1a; color: #eee; }
        
        #sidebar { width: 260px; background-color: #2c3e50; padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.5); flex-shrink: 0; }
        .title-container { text-align: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 20px; }
        #sidebar h2 { margin: 0; color: #bdc3c7; font-size: 1rem; text-transform: uppercase; letter-spacing: 3px; font-weight: normal; }
        #kk-logo { font-size: 6rem; font-weight: 900; color: #e74c3c; margin: 0; line-height: 1; letter-spacing: -5px; text-shadow: 0 0 20px rgba(231, 76, 60, 0.6); font-family: 'Arial Black', sans-serif; }
        
        input, button { padding: 10px; border-radius: 8px; border: 1px solid #555; width: 100%; box-sizing: border-box; background-color: #34495e; color: #eee; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; background: #e74c3c; color: white; border: none; }
        button:hover { opacity: 0.9; transform: scale(1.02); background-color: #c0392b; }
        
        #btn-stop { background-color: #c0392b; display: none; }
        #btn-list { background-color: #3498db; }
        #btn-prof { background-color: #95a5a6; margin-top: auto; }
        #prof-controls { border-top: 1px solid #7f8c8d; padding-top: 15px; display: none; }
        #prof-controls p { color: #e74c3c; font-size: 0.9rem; margin-top: 0; }
        .btn-delete-all { background-color: #e74c3c !important; border: 2px solid white !important; margin-top: 10px; }

        /* Main Content Layout */
        #main-content { 
            flex-grow: 1; position: relative; background: #000; display: flex; 
            justify-content: center; align-items: center; gap: 60px; 
            background-image: radial-gradient(circle at 50% 50%, rgba(231, 76, 60, 0.15) 0%, transparent 60%),
                              linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%),
                              repeating-linear-gradient(45deg, #1a1a1a 0, #1a1a1a 10px, #222 10px, #222 20px);
        }

        /* [NEW] ÏôºÏ™Ω Ïª¨Îüº (Î≤ÑÌäº + Ïù¥ÎØ∏ÏßÄ) */
        #left-column {
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }

        /* [NEW] Î™®ÎãàÌÑ∞ Ïª®Ìä∏Î°§ Î≤ÑÌäº (Ïù¥ÎØ∏ÏßÄ Î∞îÎ°ú ÏúÑ) */
        #monitor-controls {
            display: flex; gap: 10px; width: 100%; justify-content: center;
        }
        .ctrl-btn {
            background: #2c3e50; border: 1px solid #555; color: #ddd; padding: 8px 15px; 
            border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: 0.2s;
        }
        .ctrl-btn:hover, .ctrl-btn.active { background: #3b82f6; border-color: #60a5fa; color: white; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }

        .side-img { 
            height: 60vh; max-height: 600px; width: auto; object-fit: contain; 
            border: 2px solid #444; box-shadow: 0 0 30px rgba(0,0,0,0.8); 
            opacity: 0.9; transition: 0.3s; 
        }
        .side-img.alert-mode { border-color: #e74c3c; box-shadow: 0 0 50px rgba(231, 76, 60, 0.8); transform: scale(1.05); }

        /* Center Stage (Camera) */
        #center-stage { position: relative; display: flex; justify-content: center; align-items: center; width: 500px; height: 500px; }
        
        #camera-wrapper { 
            display: none; width: 500px; height: 500px; border-radius: 50%; overflow: hidden; 
            border: 5px solid #e74c3c; position: relative; background: black; 
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.6), inset 0 0 50px rgba(231, 76, 60, 0.4); 
        }
        #camera-wrapper::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 120%; height: 120%; transform: translate(-50%, -50%);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500"><circle cx="250" cy="250" r="240" fill="none" stroke="rgba(231, 76, 60, 0.5)" stroke-width="2" stroke-dasharray="10 5"/><circle cx="250" cy="250" r="180" fill="none" stroke="rgba(231, 76, 60, 0.3)" stroke-width="1"/><path d="M250 50 L250 450 M50 250 L450 250" stroke="rgba(231, 76, 60, 0.4)" stroke-width="1"/><circle cx="250" cy="250" r="50" fill="rgba(231, 76, 60, 0.2)"/></svg>');
            background-repeat: no-repeat; background-position: center; pointer-events: none; z-index: 1;
        }
        canvas { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); position: relative; z-index: 0; }
        
        /* Status Panel */
        #status-panel { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 10; width: 100%; justify-content: center; }
        .status-box { background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 30px; color: #aaa; font-weight: bold; border: 1px solid #555; display: flex; align-items: center; gap: 10px; transition: 0.3s; white-space: nowrap; }
        .active-red { color: white !important; background: rgba(255, 0, 0, 0.9) !important; border-color: red !important; box-shadow: 0 0 20px red; }
        .active-green { color: white !important; background: rgba(0, 200, 0, 0.9) !important; border-color: lime !important; box-shadow: 0 0 15px lime; }

        /* [NEW] Settings Panel (Overlay) */
        #panel-settings {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; background: rgba(20, 20, 20, 0.95); border: 1px solid #444;
            border-radius: 12px; padding: 20px; z-index: 60; display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .setting-row { margin-bottom: 15px; }
        .setting-label { display: flex; justify-content: space-between; font-size: 0.85rem; color: #aaa; margin-bottom: 5px; }
        .setting-val { color: #60a5fa; font-family: monospace; }
        input[type=range] { width: 100%; height: 4px; background: #333; accent-color: #3b82f6; }

        /* [NEW] Logs Panel (Overlay) */
        #panel-logs {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 320px; height: 400px; background: rgba(20, 20, 20, 0.95); border: 1px solid #444;
            border-radius: 12px; padding: 15px; z-index: 60; display: none;
            flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        #log-container { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .log-entry { font-size: 0.75rem; padding: 8px; background: #333; border-radius: 4px; display: flex; justify-content: space-between; color: #ccc; border-left: 3px solid #555; }
        .log-entry.violation { background: rgba(220, 38, 38, 0.2); border-left-color: #dc2626; color: white; }

        #alert-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 0, 0, 0.95); color: white; padding: 30px 60px; border-radius: 50px; font-size: 3rem; font-weight: bold; display: none; z-index: 200; box-shadow: 0 0 100px red; animation: pulse 0.3s infinite alternate; text-align: center; white-space: nowrap; }
        @keyframes pulse { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.1); } }
        
        /* List Panel (Original) */
        #list-panel { position: fixed; left: -400px; top: 0; bottom: 0; width: 300px; background: rgba(44, 62, 80, 0.98); padding: 20px; transition: 0.3s; z-index: 50; overflow-y: auto; box-shadow: 5px 0 15px rgba(0,0,0,0.5); color: #eee; }
        #list-panel.open { left: 300px; } 
        #list-panel h3 { color: #e74c3c; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .student-item { background: #34495e; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #555; display: flex; flex-direction: column; gap: 5px; transition: 0.3s; }
        .student-item.problematic { background: linear-gradient(135deg, #621010 0%, #3a0000 100%); border: 2px solid #ff0000; box-shadow: 0 0 10px rgba(255, 0, 0, 0.4); animation: shake 0.5s; }
        .item-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .student-info b { font-size: 1.1rem; }
        .student-info span { font-size: 0.9rem; color: #bbb; }
        .count-badge { background: #e67e22; color: white; padding: 4px 10px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 0.9rem; min-width: 25px; text-align: center; }
        .timestamp-list { display: none; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; font-size: 0.8rem; color: #aaa; max-height: 150px; overflow-y: auto; }
        .del-btn { background: #c0392b; color: white; border: none; padding: 5px; font-size: 0.8rem; width: 100%; margin-top: 10px; border-radius: 4px; display: none; }
        
        #input_video { display: none; }
        #loading-msg { color: #e74c3c; font-weight: bold; display: none; margin-top: 10px; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="title-container">
            <h2>Korean Killer</h2>
            <div id="kk-logo">KK</div>
        </div>
        <input type="text" id="input-name" placeholder="Name">
        <input type="text" id="input-id" placeholder="Student ID">
        <button id="btn-start" onclick="startSystem()">‚ñ∂ Start Monitoring</button>
        <div id="loading-msg">Loading AI Models...</div>
        <button id="btn-stop" onclick="location.reload()">‚èπ Stop System</button>
        <button id="btn-list" onclick="toggleList()">üìã Detection List</button>
        <div id="prof-controls">
            <p>üëÆ‚Äç‚ôÇÔ∏è [Professor Mode]</p>
            <input type="text" id="add-name" placeholder="Name" style="margin-bottom:5px;">
            <input type="text" id="add-id" placeholder="ID" style="margin-bottom:5px;">
            <button onclick="manualAdd()" style="background:#ff9800;">Manual Add</button>
            <hr style="border-color:#555; margin: 15px 0;">
            <button onclick="deleteAllData()" class="btn-delete-all">‚ö†Ô∏è DELETE ALL DATA</button>
        </div>
        <button id="btn-prof" onclick="authProfessor()">üîí Admin Auth</button>
    </div>

    <div id="list-panel">
        <h3>üö® Detected Students</h3>
        <ul id="student-list" style="list-style: none; padding: 0;"></ul>
    </div>

    <div id="main-content">
        <div id="left-column">
            <div id="monitor-controls">
                <button class="ctrl-btn" onclick="togglePanel('settings')">‚öôÔ∏è Settings</button>
                <button class="ctrl-btn" onclick="togglePanel('logs')">üìä Live Log</button>
            </div>
            
            <img src="1.jpg" id="monitor-image" class="side-img" alt="Surveillance Monitor">
        </div>

        <div id="center-stage">
            <div id="placeholder" style="text-align:center;">
                <h1 style="color:white;">System Standby</h1>
                <p style="color:#aaa;">Please enter your Name and ID to start.</p>
            </div>

            <div id="status-panel" style="display:none;">
                <div id="status-audio" class="status-box">üé§ AI Standby</div>
                <div id="status-video" class="status-box">ü§ê 0%</div>
            </div>

            <div id="camera-wrapper">
                <canvas id="output_canvas"></canvas>
                <div id="alert-overlay">üö® DETECTED!</div>
            </div>

            <div id="panel-settings">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; color:#3b82f6; font-weight:bold;">
                    <span>SETTINGS</span><span style="cursor:pointer" onclick="togglePanel('settings')">‚úï</span>
                </div>
                <div class="setting-row">
                    <div class="setting-label"><span>AI Confidence</span><span id="txt-conf">50%</span></div>
                    <input type="range" min="1" max="99" value="50" oninput="updateSettings('confidence', this.value)">
                </div>
                <div class="setting-row">
                    <div class="setting-label"><span>Mouth Open</span><span id="txt-gap">1.0%</span></div>
                    <input type="range" min="1" max="50" value="10" oninput="updateSettings('mouthOpen', this.value)">
                </div>
                <div class="setting-row">
                    <div class="setting-label"><span>Lip Movement</span><span id="txt-move">Lv 20</span></div>
                    <input type="range" min="1" max="100" value="20" oninput="updateSettings('lipMovement', this.value)">
                </div>
                <div class="setting-row">
                    <div class="setting-label"><span>Strictness</span><span id="txt-strict">3 frames</span></div>
                    <input type="range" min="1" max="10" value="3" oninput="updateSettings('strictness', this.value)">
                </div>
            </div>

            <div id="panel-logs">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#3b82f6; font-weight:bold;">
                    <span>LIVE LOGS</span><span style="cursor:pointer" onclick="togglePanel('logs')">‚úï</span>
                </div>
                <div id="log-container">
                    <div style="text-align:center; color:#555; margin-top:20px;">Waiting for data...</div>
                </div>
            </div>
        </div>
    </div>

    <video id="input_video" playsinline></video>

    <script>
        var Module = typeof Module !== 'undefined' ? Module : {};
        let classifierInitialized = false;
        Module.onRuntimeInitialized = function() { classifierInitialized = true; };

        class EdgeImpulseClassifier {
            constructor() { this._module = Module; }
            init() {
                if (classifierInitialized === true) return Promise.resolve();
                return new Promise((resolve, reject) => {
                    if (!this._module || !this._module.onRuntimeInitialized) { if (window.Module) this._module = window.Module; }
                    this._module.onRuntimeInitialized = () => {
                        classifierInitialized = true;
                        this._module.init();
                        resolve();
                    };
                });
            }
            classify(rawData, debug = false) {
                if (!classifierInitialized) throw new Error('Module is not initialized');
                if (!this._module._malloc && window.Module) { this._module = window.Module; }
                const obj = this._arrayToHeap(rawData);
                let ret = this._module.run_classifier(obj.buffer.byteOffset, rawData.length, debug);
                this._module._free(obj.ptr);
                if (ret.result !== 0) throw new Error('Classification failed (err code: ' + ret.result + ')');
                let jsResult = { results: [] };
                for (let cx = 0; cx < ret.size(); cx++) {
                    let c = ret.get(cx);
                    jsResult.results.push({ label: c.label, value: c.value });
                    c.delete();
                }
                ret.delete();
                return jsResult;
            }
            _arrayToHeap(data) {
                let typedArray = new Float32Array(data);
                let numBytes = typedArray.length * typedArray.BYTES_PER_ELEMENT;
                let ptr = this._module._malloc(numBytes);
                let heapBytes = new Uint8Array(this._module.HEAPU8.buffer, ptr, numBytes);
                heapBytes.set(new Uint8Array(typedArray.buffer));
                return { ptr: ptr, buffer: heapBytes };
            }
        }
    </script>

    <script>
        // 1. Firebase (Original)
        const firebaseConfig = {
            apiKey: "AIzaSyDaLlrTKsMCpCzVgBW9icTmEPcuO_zoWVY",
            authDomain: "acdt-project.firebaseapp.com",
            projectId: "acdt-project",
            storageBucket: "acdt-project.firebasestorage.app",
            messagingSenderId: "243281762920",
            appId: "1:243281762920:web:6641d9eadfe1e93442f9dd",
            measurementId: "G-J9TVZXN3LE"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. State & Settings (React Logic)
        let isRunning = false;
        let userName = "", userId = "";
        let classifier = null;
        
        const settings = {
            confidence: 0.50,
            mouthOpen: 0.01,
            lipMovement: 0.002,
            strictness: 3
        };

        const lipHistory = [];
        const violationQueue = [];
        let alertTimeout = null;
        let currentAudioResult = { label: 'noise', score: 0 };

        // 3. UI Controls
        function togglePanel(name) {
            const ps = document.getElementById('panel-settings');
            const pl = document.getElementById('panel-logs');
            if (name === 'settings') {
                ps.style.display = ps.style.display === 'block' ? 'none' : 'block';
                pl.style.display = 'none';
            } else {
                pl.style.display = pl.style.display === 'flex' ? 'none' : 'flex';
                ps.style.display = 'none';
            }
        }

        function updateSettings(key, value) {
            if(key==='confidence'){ settings.confidence=value/100; document.getElementById('txt-conf').innerText=value+'%'; }
            if(key==='mouthOpen'){ settings.mouthOpen=value/1000; document.getElementById('txt-gap').innerText=(value/10).toFixed(1)+'%'; }
            if(key==='lipMovement'){ settings.lipMovement=value/10000; document.getElementById('txt-move').innerText='Lv '+value; }
            if(key==='strictness'){ settings.strictness=value; document.getElementById('txt-strict').innerText=value+' frames'; }
        }

        function addLog(label, score, visual, isViolation) {
            const container = document.getElementById('log-container');
            const now = new Date().toLocaleTimeString('en-US',{hour12:false});
            const div = document.createElement('div');
            div.className = `log-entry ${isViolation ? 'violation' : ''}`;
            div.innerHTML = `<span>[${now}] ${label.toUpperCase()}</span><span>${visual} / ${Math.round(score*100)}%</span>`;
            container.insertBefore(div, container.firstChild);
            if(container.children.length>20) container.removeChild(container.lastChild);
        }

        // 4. GitHub Logic: Math Helpers
        function calculateStandardDeviation(arr) {
            if (arr.length === 0) return 0;
            const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
            const variance = arr.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / arr.length;
            return Math.sqrt(variance);
        }

        function downsampleBuffer(buffer, sampleRate, outSampleRate) {
            if (outSampleRate == sampleRate) return buffer;
            var sampleRateRatio = sampleRate / outSampleRate;
            var newLength = Math.round(buffer.length / sampleRateRatio);
            var result = new Float32Array(newLength);
            var offsetResult = 0; var offsetBuffer = 0;
            while (offsetResult < result.length) {
                var nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                var accum = 0, count = 0;
                for (var i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) { accum += buffer[i]; count++; }
                result[offsetResult] = accum / count; offsetResult++; offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        // 5. System Start
        async function startSystem() {
            userName = document.getElementById('input-name').value;
            userId = document.getElementById('input-id').value;
            if (!userName || !userId) { alert("Please enter Name and Student ID!"); return; }

            const btn = document.getElementById('btn-start');
            const msg = document.getElementById('loading-msg');
            btn.disabled = true; msg.style.display = 'block';

            try {
                // Init Edge Impulse
                classifier = new EdgeImpulseClassifier();
                await classifier.init();
                
                // Init Audio
                await startAudioProcessing();

                // Init FaceMesh
                await startFaceMesh();

                // UI Ready
                msg.style.display = 'none';
                btn.style.display = 'none';
                document.getElementById('btn-stop').style.display = 'block';
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('camera-wrapper').style.display = 'block';
                document.getElementById('status-panel').style.display = 'flex';
                
                isRunning = true;
                // Auto open logs
                togglePanel('logs');

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                location.reload();
            }
        }

        async function startAudioProcessing() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            const targetRate = 16000; 
            const processor = audioContext.createScriptProcessor(4096, 1, 1);
            let audioBuffer = new Float32Array(targetRate * 1); 
            let bufferIdx = 0;

            source.connect(processor);
            processor.connect(audioContext.destination);

            processor.onaudioprocess = function(e) {
                if (!isRunning) return;
                const inputData = e.inputBuffer.getChannelData(0);
                const downsampled = downsampleBuffer(inputData, audioContext.sampleRate, targetRate);
                for (let i = 0; i < downsampled.length; i++) {
                    if (bufferIdx < audioBuffer.length) { audioBuffer[bufferIdx] = downsampled[i]; bufferIdx++; }
                    else {
                        runClassification(audioBuffer);
                        bufferIdx = 0;
                    }
                }
            };
        }

        async function runClassification(data) {
            if(!classifier) return;
            let results = classifier.classify(data);
            // Get top result
            let top = results.results.reduce((p, c) => p.value > c.value ? p : c);
            currentAudioResult = { label: top.label, score: top.value };

            // Update Audio Status UI
            const audioBox = document.getElementById('status-audio');
            audioBox.innerText = `üé§ ${top.label.toUpperCase()} (${Math.round(top.value*100)}%)`;
            if(top.label === 'korean' && top.value > settings.confidence) audioBox.className = "status-box active-red";
            else audioBox.className = "status-box";
        }

        async function startFaceMesh() {
            const videoElement = document.getElementById('input_video');
            const canvasElement = document.getElementById('output_canvas');
            const ctx = canvasElement.getContext('2d');
            const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
            faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5 });
            
            faceMesh.onResults((results) => {
                if (!isRunning) return;
                canvasElement.width = 500; canvasElement.height = 500;
                ctx.fillStyle = "black"; ctx.fillRect(0, 0, 500, 500);

                let visualState = "Closed";
                
                if (results.image && results.multiFaceLandmarks.length > 0) {
                    const lm = results.multiFaceLandmarks[0];
                    const upper = lm[13]; const lower = lm[14];
                    
                    // [GitHub Logic] Gap & StdDev
                    const gap = lower.y - upper.y;
                    lipHistory.push(gap);
                    if (lipHistory.length > 5) lipHistory.shift();
                    const movement = calculateStandardDeviation(lipHistory);

                    // Draw Camera
                    const sW = videoElement.videoWidth; const sH = videoElement.videoHeight;
                    const zoom = 4.0; const cw = sW/zoom; const ch = sH/zoom;
                    let cx = ((upper.x + lower.x)/2 * sW) - cw/2;
                    let cy = ((upper.y + lower.y)/2 * sH) - ch/2;
                    ctx.drawImage(results.image, cx, cy, cw, ch, 0, 0, 500, 500);

                    // Decision
                    if (gap > settings.mouthOpen) {
                        visualState = movement > settings.lipMovement ? "Speaking" : "Open";
                    }

                    // Combined Check
                    const isKorean = currentAudioResult.label === 'korean' && currentAudioResult.score > settings.confidence;
                    const isMouthActive = visualState === "Speaking";
                    
                    if(isKorean && isMouthActive) violationQueue.push(1);
                    else violationQueue.push(0);
                    if(violationQueue.length > 10) violationQueue.shift();

                    if(violationQueue.filter(v => v===1).length >= settings.strictness) {
                        triggerDetection();
                        addLog(currentAudioResult.label, currentAudioResult.score, visualState, true);
                    } else if (Math.random() < 0.05) {
                        addLog(currentAudioResult.label, currentAudioResult.score, visualState, false);
                    }
                }

                // Update Video Status UI
                const vStatus = document.getElementById('status-video');
                vStatus.innerText = `${visualState === 'Speaking' ? 'üó£Ô∏è' : 'ü§ê'} ${visualState}`;
                vStatus.className = visualState === 'Speaking' ? "status-box active-green" : "status-box";
            });

            const camera = new Camera(videoElement, {
                onFrame: async () => { await faceMesh.send({image: videoElement}); },
                width: 1280, height: 720
            });
            await camera.start();
        }

        function triggerDetection() {
            if (alertTimeout) return; 
            const overlay = document.getElementById('alert-overlay');
            overlay.style.display = 'block';
            
            const img = document.getElementById('monitor-image');
            img.src = "2.jpg"; img.classList.add('alert-mode');

            db.collection("detections").add({ 
                name: userName, studentId: userId, 
                reason: `Korean(${Math.round(currentAudioResult.score*100)}%)`, 
                timestamp: firebase.firestore.FieldValue.serverTimestamp() 
            });

            alertTimeout = setTimeout(() => {
                overlay.style.display = 'none';
                img.src = "1.jpg"; img.classList.remove('alert-mode');
                alertTimeout = null;
                violationQueue.length = 0;
            }, 3000);
        }

        // Original Helpers
        function toggleList() { document.getElementById('list-panel').classList.toggle('open'); }
        function authProfessor() { if (prompt("Password:") === "kyj") { document.getElementById('prof-controls').style.display='block'; document.getElementById('btn-prof').style.display='none'; loadList(); } }
        function manualAdd() { const n=document.getElementById('add-name').value; const i=document.getElementById('add-id').value; if(n&&i) db.collection("detections").add({name:n, studentId:i, timestamp:firebase.firestore.FieldValue.serverTimestamp()}); }
        async function deleteAllData() { if(confirm("Delete ALL?")) { const snap = await db.collection("detections").get(); const batch = db.batch(); snap.docs.forEach(d=>batch.delete(d.ref)); await batch.commit(); } }
        function loadList() { db.collection("detections").orderBy("timestamp", "desc").onSnapshot(s => { const list = document.getElementById('student-list'); list.innerHTML = ""; const st = {}; s.forEach(d => { const dt=d.data(); if(!st[dt.studentId]) st[dt.studentId]={name:dt.name, id:dt.studentId, cnt:0}; st[dt.studentId].cnt++; }); Object.values(st).forEach(s => { const li=document.createElement('li'); li.className='student-item'; li.innerHTML=`<b>${s.name}</b> (${s.id}) <span class="count-badge">${s.cnt}</span>`; list.appendChild(li); }); }); }
        loadList(); 
    </script>
</body>
</html>
